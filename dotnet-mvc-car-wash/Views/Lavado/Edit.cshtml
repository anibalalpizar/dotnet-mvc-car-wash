@model dotnet_mvc_car_wash.Models.Lavado
@{
    ViewData["Title"] = "Editar Lavado";
}
<h2>Editar Lavado</h2>
<form asp-action="Edit">
    <div asp-validation-summary="ModelOnly"></div>
    <input type="hidden" asp-for="IdLavado" />
    <input type="hidden" asp-for="FechaCreacion" />

    <div>
        <label asp-for="IdLavado"></label>
        <input asp-for="IdLavado" readonly />
        <span asp-validation-for="IdLavado"></span>
    </div>

    <div>
        <label asp-for="PlacaVehiculo"></label>
        <input asp-for="PlacaVehiculo" />
        <span asp-validation-for="PlacaVehiculo"></span>
    </div>

    <div>
        <label asp-for="IdCliente"></label>
        <input asp-for="IdCliente" />
        <span asp-validation-for="IdCliente"></span>
    </div>

    <div>
        <label asp-for="IdEmpleado"></label>
        <input asp-for="IdEmpleado" />
        <span asp-validation-for="IdEmpleado"></span>
    </div>

    <div>
        <label asp-for="TipoLavado"></label>
        <select asp-for="TipoLavado" asp-items="Html.GetEnumSelectList<dotnet_mvc_car_wash.Models.TipoLavado>()" id="tipoLavadoSelect">
            <option value="">-- Seleccione un tipo --</option>
        </select>
        <span asp-validation-for="TipoLavado"></span>
    </div>

    <div id="precioAConvenirDiv" style="display: none;">
        <label asp-for="PrecioAConvenir"></label>
        <input asp-for="PrecioAConvenir" type="number" step="0.01" min="0" />
        <span asp-validation-for="PrecioAConvenir"></span>
        <small>Ingrese el precio acordado con el cliente (sin IVA)</small>
    </div>

    <div>
        <label asp-for="EstadoLavado"></label>
        <select asp-for="EstadoLavado" asp-items="Html.GetEnumSelectList<dotnet_mvc_car_wash.Models.EstadoLavado>()">
            <option value="">-- Seleccione un estado --</option>
        </select>
        <span asp-validation-for="EstadoLavado"></span>
    </div>

    <div>
        <label asp-for="Observaciones"></label>
        <textarea asp-for="Observaciones" rows="3"></textarea>
        <span asp-validation-for="Observaciones"></span>
    </div>

    <div>
        <label>Fecha de Creación:</label>
        <span>@Model.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</span>
    </div>

    @if (Model.PrecioBase > 0)
    {
        <div>
            <h4>Información de Precios Actuales:</h4>
            <p><strong>Precio Base:</strong> ₡@Model.PrecioBase.ToString("N0")</p>
            <p><strong>IVA (13%):</strong> ₡@Model.IVA.ToString("N0")</p>
            <p><strong>Precio Total:</strong> ₡@Model.PrecioTotal.ToString("N0")</p>
            <p><em>Los precios se recalcularán automáticamente si cambia el tipo de lavado</em></p>
        </div>
    }

    <div>
        <p><strong>Precios por tipo de lavado:</strong></p>
        <ul>
            @foreach (var tipo in Enum.GetValues<dotnet_mvc_car_wash.Models.TipoLavado>())
            {
                var tempLavado = new dotnet_mvc_car_wash.Models.Lavado { TipoLavado = tipo };
                tempLavado.CalcularPrecios();
                <li>
                    <strong>@tipo:</strong>
                    @if (tempLavado.PrecioBase > 0)
                    {
                        <text>₡@tempLavado.PrecioBase.ToString("N0") - </text>
                    }
                    else
                    {
                        <text>A convenir - </text>
                    }
                    @tempLavado.GetTipoLavadoDescripcion()
                </li>
            }
        </ul>
        <p><em>Los precios mostrados no incluyen IVA (13%)</em></p>
    </div>

    <div>
        <input type="submit" value="Guardar Cambios" />
        <a asp-action="Index">Volver a la lista</a> |
        <a asp-action="Details" asp-route-id="@Model.IdLavado">Ver Detalles</a>
    </div>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.getElementById('tipoLavadoSelect').addEventListener('change', function() {
            var tipoLavado = this.value;
            var precioAConvenirDiv = document.getElementById('precioAConvenirDiv');
            var precioAConvenirInput = document.querySelector('input[name="PrecioAConvenir"]');

            if (tipoLavado === '3') { // 3 corresponde a LaJoya en el enum
                precioAConvenirDiv.style.display = 'block';
                precioAConvenirInput.setAttribute('required', 'required');
            } else {
                precioAConvenirDiv.style.display = 'none';
                precioAConvenirInput.removeAttribute('required');
                precioAConvenirInput.value = '';
            }
        });

        // Verificar el estado inicial en caso de que ya tenga un valor seleccionado
        document.addEventListener('DOMContentLoaded', function() {
            var tipoLavadoSelect = document.getElementById('tipoLavadoSelect');
            var event = new Event('change');
            tipoLavadoSelect.dispatchEvent(event);
        });
    </script>
}